name: Debug Workflow

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch:
    inputs:
      test_number:
        description: "Phone number to test (e.g., 081234567890)"
        required: true
        default: "081234567890"
      headless:
        description: "Run in headless mode"
        required: true
        default: true
        type: boolean

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpulse0 \
            libwayland-client0 \
            libwayland-cursor0 \
            libwayland-egl1 \
            libwayland-server0 \
            libx11-xcb1 \
            libxcb-dri3-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-util1 \
            libxcb-xfixes0 \
            libxcb-xinerama0 \
            libxcb-xkb1 \
            libxkbcommon-x11-0 \
            xvfb

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install requests cloudscraper requests_toolbelt undetected-playwright
          playwright install chromium firefox --with-deps

          # Install stealth plugin
          mkdir -p ~/.cache/ms-playwright/firefox/stealth
          curl -o ~/.cache/ms-playwright/firefox/stealth/stealth.min.js https://raw.githubusercontent.com/berstend/puppeteer-extra/master/packages/puppeteer-extra-plugin-stealth/evasions/_generated/stealth.min.js

      - name: Verify Playwright installation
        run: |
          python -c "
          from playwright.sync_api import sync_playwright
          with sync_playwright() as p:
              browser = p.chromium.launch()
              browser.close()
          print('âœ… Playwright verification successful')
          "

      - name: Create debug configuration
        run: |
          echo "DEBUG=true" >> .env
          echo "TEST_NUMBER=${{ github.event.inputs.test_number }}" >> .env
          echo "HEADLESS=${{ github.event.inputs.headless }}" >> .env

      - name: Modify debug script for CI
        run: |
          cat > scripts/checker_debug_ci.py << 'EOF'
          import asyncio
          import cloudscraper
          import json
          import random
          import time
          from playwright.async_api import async_playwright
          from requests_toolbelt.adapters import source

          def random_delay():
              """Add random delay untuk simulasi human behavior"""
              time.sleep(random.uniform(2, 5))

          def get_random_ip():
              """Generate random IP untuk X-Forwarded-For"""
              return f"{random.randint(1,255)}.{random.randint(1,255)}.{random.randint(1,255)}.{random.randint(1,255)}"

          def get_cf_cookies():
              """Get cookies dari Cloudflare menggunakan cloudscraper"""
              try:
                  # Konfigurasi interpreter untuk bypass Cloudflare
                  interpreter = {
                      "navigator.user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0"
                  }

                  # Buat scraper dengan konfigurasi yang direkomendasikan
                  scraper = cloudscraper.create_scraper(
                      interpreter=interpreter,
                      browser={
                          'browser': 'firefox',
                          'platform': 'windows',
                          'mobile': False
                      },
                      delay=10,  # Delay antara request
                      debug=True
                  )

                  print("Mencoba mendapatkan cookies dengan cloudscraper...")
                  
                  # Coba beberapa kali jika gagal
                  max_retries = 3
                  for attempt in range(max_retries):
                      try:
                          print(f"Attempt {attempt + 1}/{max_retries}")
                          
                          # GET request untuk mendapatkan challenge
                          response = scraper.get(
                              "https://ceebydith.com/cek-hlr-lokasi-hp.html",
                              timeout=30
                          )
                          
                          print(f"Status code: {response.status_code}")
                          print(f"CF-RAY header: {response.headers.get('CF-RAY', 'Not found')}")
                          
                          if response.status_code == 200:
                              cookies = scraper.cookies.get_dict()
                              if cookies:
                                  print("Cookies berhasil didapat!")
                                  print(f"Cookie names: {list(cookies.keys())}")
                                  return cookies
                              else:
                                  print("Response 200 tapi tidak ada cookies")
                          else:
                              print(f"Response tidak 200: {response.status_code}")
                              print(f"Response headers: {dict(response.headers)}")
                      
                      except cloudscraper.exceptions.CloudflareChallengeError as e:
                          print(f"Cloudflare challenge error: {str(e)}")
                          if attempt < max_retries - 1:
                              print("Menunggu sebelum mencoba lagi...")
                              time.sleep(5)
                          continue
                          
                      except Exception as e:
                          print(f"Error tidak terduga: {str(e)}")
                          if attempt < max_retries - 1:
                              time.sleep(5)
                          continue
                  
                  print("Semua percobaan gagal")
                  return {}
                      
              except Exception as e:
                  print(f"Error fatal: {str(e)}")
                  return {}

          async def scrape_basic_info():
              """Scrape title dan description dari halaman web"""
              # Get Cloudflare cookies first
              print("Mendapatkan cookies Cloudflare...")
              cf_cookies = get_cf_cookies()  # Call sync function
              if not cf_cookies:
                  print("Tidak bisa mendapatkan cookies Cloudflare, mencoba tanpa cookies...")
              else:
                  print(f"Cookies didapat: {json.dumps(cf_cookies, indent=2)}")
              try:
                  async with async_playwright() as p:
                      print("Launching Firefox with stealth mode...")
                      browser = await p.firefox.launch(
                          headless=True,
                          firefox_user_prefs={
                              # Enhanced privacy settings
                              'privacy.resistFingerprinting': True,
                              'privacy.trackingprotection.enabled': True,
                              'network.http.sendRefererHeader': 0,
                              'media.navigator.enabled': False,
                              'media.peerconnection.enabled': False,
                              'dom.webaudio.enabled': False,
                              'dom.webnotifications.enabled': False,
                              'beacon.enabled': False,
                              'javascript.enabled': True,
                              'dom.webdriver.enabled': False,
                              'useAutomationExtension': False,
                              'plugins.emulated': False
                          }
                      )
                      
                      # Load stealth script
                      with open('~/.cache/ms-playwright/firefox/stealth/stealth.min.js', 'r') as f:
                          stealth_js = f.read()
                      
                      # Buat context dengan user agent Firefox
                      context = await browser.new_context(
                          user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0',
                          viewport={'width': 1920, 'height': 1080},
                          java_script_enabled=True,
                          bypass_csp=True  # Bypass Content Security Policy
                      )
                      
                      # Buat page baru
                      page = await context.new_page()
                      
                      # Set cookies dari cloudscraper
                      print("Setting cookies...")
                      for name, value in cf_cookies.items():
                          await context.add_cookies([{
                              'name': name,
                              'value': value,
                              'domain': 'ceebydith.com',
                              'path': '/'
                          }])
                      
                      # Inject stealth script
                      await page.add_init_script(stealth_js)
                      
                      # Set more realistic headers
                      random_delay()  # Simulate human delay
                      await page.set_extra_http_headers({
                          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
                          'Accept-Language': 'en-US,en;q=0.9',
                          'Accept-Encoding': 'gzip, deflate',
                          'Connection': 'keep-alive',
                          'Cache-Control': 'max-age=0',
                          'DNT': '1',
                          'Upgrade-Insecure-Requests': '1',
                          'X-Forwarded-For': get_random_ip(),
                          'X-Real-IP': get_random_ip()
                      })
                      
                      # Simulate human-like behavior before navigation
                      random_delay()
                      
                      print("Membuka halaman...")
                      try:
                          # Emulate human-like navigation
                          await page.evaluate("""
                              // Override navigator properties
                              Object.defineProperty(navigator, 'webdriver', { get: () => false });
                              Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
                              
                              // Add random mouse movements
                              const moveMouseRandomly = () => {
                                  const x = Math.floor(Math.random() * window.innerWidth);
                                  const y = Math.floor(Math.random() * window.innerHeight);
                                  const event = new MouseEvent('mousemove', {
                                      view: window,
                                      bubbles: true,
                                      cancelable: true,
                                      clientX: x,
                                      clientY: y
                                  });
                                  document.dispatchEvent(event);
                              };
                              setInterval(moveMouseRandomly, 1000);
                          """)
                          
                          print("Mencoba mengakses halaman...")
                          await page.goto("https://ceebydith.com/cek-hlr-lokasi-hp.html", 
                                        wait_until="domcontentloaded",
                                        timeout=60000)
                      except Exception as e:
                          print(f"Initial navigation error: {str(e)}")
                          print("Mencoba recovery mode...")
                          # Try alternative approach
                          await page.goto("https://ceebydith.com/cek-hlr-lokasi-hp.html", 
                                        wait_until="commit",
                                        timeout=30000)
                      
                      # Tunggu sampai challenge selesai
                      print("Menunggu halaman selesai loading...")
                      try:
                          print("Menunggu networkidle state...")
                          await page.wait_for_load_state("networkidle", timeout=30000)
                      except Exception as e:
                          print(f"Network idle timeout: {str(e)}")
                          
                      print("Menunggu tambahan 10 detik...")
                      await page.wait_for_timeout(10000)  # Increased wait time
                      
                      # Get page title
                      title = await page.title()
                      print(f"Title: {title}")
                      
                      max_retries = 5
                      retry_count = 0
                      
                      while "Just a moment" in title and retry_count < max_retries:
                          print(f"Terdeteksi Cloudflare challenge, menunggu... (attempt {retry_count + 1}/{max_retries})")
                          
                          try:
                              # Coba klik checkbox jika ada
                              checkbox = await page.query_selector("#challenge-stage")
                              if checkbox:
                                  await checkbox.click()
                          except Exception as e:
                              print(f"No clickable challenge element found: {str(e)}")
                          
                          # Tunggu lebih lama
                          await page.wait_for_timeout(15000)
                          
                          # Cek apakah ada perubahan konten
                          old_content = await page.content()
                          await page.wait_for_timeout(5000)
                          new_content = await page.content()
                          
                          if old_content != new_content:
                              print("Halaman berubah, menunggu selesai...")
                              await page.wait_for_timeout(10000)
                          
                          title = await page.title()
                          print(f"Title setelah menunggu: {title}")
                          retry_count += 1
                      
                      if "Just a moment" in title:
                          print("Gagal melewati Cloudflare challenge setelah beberapa percobaan")
                      
                      # Get meta description
                      description = await page.evaluate("""() => {
                          const meta = document.querySelector('meta[name="description"]');
                          return meta ? meta.getAttribute('content') : '';
                      }""")
                      print(f"Description: {description}")
                      
                      # Save halaman untuk debug
                      content = await page.content()
                      print(f"\nPage content length: {len(content)} bytes")
                      print("Saving page content to debug.html...")
                      with open("debug.html", "w", encoding="utf-8") as f:
                          f.write(content)
                      
                      await context.close()
                      await browser.close()
              except Exception as e:
                  print(f"Error: {str(e)}")
                  raise e
              
          if __name__ == "__main__":
              asyncio.run(scrape_basic_info())
          EOF

      - name: Run debug test
        run: |
          export NODE_TLS_REJECT_UNAUTHORIZED=0  # Allow self-signed certificates for testing
          python scripts/checker_debug_ci.py

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts
          path: |
            *.html
            *.png
            *.txt
          retention-days: 7
